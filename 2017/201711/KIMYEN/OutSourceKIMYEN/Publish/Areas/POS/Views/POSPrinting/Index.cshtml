@{
    Layout = "~/Views/Shared/_ClassicLayout.cshtml";
    ViewBag.Title = "Index - Print";
}

<h2>Index</h2>
<div id="content">
    <ul id="printer-list">       
    </ul>
</div>

@section signalRScripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.1.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script type="text/javascript">
        // First, checks if it isn't implemented yet.
        if (!String.prototype.format) {
            String.prototype.format = function () {
                var args = arguments;
                return this.replace(/{(\d+)}/g, function (match, number) {
                    return typeof args[number] != 'undefined'
                      ? args[number]
                      : match
                    ;
                });
            };
        }

        $(function () {
            var WEB_CLIENT_NAME = 'Web Client',
                TYPE1 = 'BILL FOOD',
                TYPE2 = 'BILL DRINKS',
                log = console.log,
                printerHub = $.connection.printerHub;

            printerHub.client.onSuccess = function (winClientName, printerName, message) {
                alert('Success, using printer: ' + printerName);
                console.log(winClientName + ': ' + printerName);
            };

            printerHub.client.onError = function (winClientName, printerName, message) {
                if (!message) {
                    alert('Error, using printer: ' + printerName);
                } else {
                    alert('FATAL: ' + message);
                }
            };
            printerHub.client.getPrinterNames = function (printers) {
                console.log(printers);
                var i = 0, printer, li, printerList = $("#printer-list");
                printerList.text('');
                for (; printer = printers[i++];) {
                    li = "<li>"
                        + "<span>"
                            + "<button class='print-btn' data-client-id='{1}' data-printer-name='{0}'>Print</button>"
                        + "</span>"
                        + "{0} | {1}"
                        + "</li>";

                    printerList.append(li.format(printer.PrinterName, printer.ClientID));
                }

                $(".print-btn").on('click', function (e) {
                    var printerName = $(e.currentTarget).attr('data-printer-name');
                    printerHub.server.print(WEB_CLIENT_NAME, printerName, TYPE1);

                });
            }

            $.connection.hub.start().done(function () {
                //Calls the onClientConnect method of the server
                printerHub.server.webNotify(WEB_CLIENT_NAME);
                //printer.client.onSuccess = function (message, name) {
                //    alert('Success');
                //};

                printerHub.server.sendPrinterNames(WEB_CLIENT_NAME);

                

            });


            //printer.client.enters = function (name) {
            //    $('#chats').append('<div class="border"><i>' + name + ' enters chatroom</i></div>');
            //    $("#users").append('<option value="' + name + '">' + name + '</option>');
            //    $('#onlineList').append('<div class="border">' + name + '</div>');
            //};
        });
    </script>
}
